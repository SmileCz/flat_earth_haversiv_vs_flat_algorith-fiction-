# Example portainer-stack.yml with two deployment options
#
# Option 1 - Swarm (recommended, uses Docker secrets)
#   - Keep original `portainer-stack.yml` as-is and ensure the secret `ip_hash_secret` exists
#   - Create secret in Portainer UI or via `docker secret create ip_hash_secret ./secrets/ip_hash_secret`
#   - Deploy with `docker stack deploy -c portainer-stack.yml plochy_stack`
#
# Option 2 - Compose / non-Swarm (fallback)
#   - If you cannot use Docker Swarm secrets, mount a file into the container at
#     /run/secrets/ip_hash_secret (this mimics the Docker secrets path)
#   - Create a local file ./secrets/ip_hash_secret with the secret value and use the
#     compose fragment below (remove the `secrets:` top-level block and the service
#     `secrets:` reference).

# -----------------------
# Option 1: Swarm (same as original)
# -----------------------
version: "3.8"

services:
  plochy_harvesine:
    image: smilecz/plochy_harvesine:latest
    container_name: plochy_harvesine
    restart: unless-stopped

    networks:
      - edge

    environment:
      - ACCESS_LOG_FILE=/logs/access.log
      - ANONYMIZE_IP=true
      - ACCESS_LOG_BUFFER_SIZE=1000
      - LOG_ROTATE_BYTES=10485760
      - LOG_ROTATE_MAX_FILES=5
      - LOG_ROTATE_CHECK_INTERVAL=60
      - LOG_ROTATE_MIN_INTERVAL_SECONDS=10

    volumes:
      - plochy_logs:/logs

    secrets:
      - ip_hash_secret

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=edge"

      - "traefik.http.routers.plochy.rule=Host(`plochy-harvesine.gearground.cloud`)"
      - "traefik.http.routers.plochy.entrypoints=websecure"
      - "traefik.http.routers.plochy.tls=true"
      - "traefik.http.routers.plochy.tls.certresolver=le"
      - "traefik.http.routers.plochy.priority=100"
      - "traefik.http.services.plochy.loadbalancer.server.port=80"

      - "traefik.http.routers.plochy_http.rule=Host(`plochy-harvesine.gearground.cloud`)"
      - "traefik.http.routers.plochy_http.entrypoints=web"
      - "traefik.http.routers.plochy_http.middlewares=plochy_https_redirect"
      - "traefik.http.middlewares.plochy_https_redirect.redirectscheme.scheme=https"

      - "traefik.http.routers.plochy.middlewares=plochy-errors-404@docker,plochy-errors-5xx@docker"

      - "traefik.http.middlewares.plochy-errors-404.errors.status=404"
      - "traefik.http.middlewares.plochy-errors-404.errors.service=error-pages-svc@docker"
      - "traefik.http.middlewares.plochy-errors-404.errors.query=/404.html"

      - "traefik.http.middlewares.plochy-errors-5xx.errors.status=500-599"
      - "traefik.http.middlewares.plochy-errors-5xx.errors.service=error-pages-svc@docker"
      - "traefik.http.middlewares.plochy-errors-5xx.errors.query=/error.html"

    deploy:
      resources:
        limits:
          memory: 32M


networks:
  edge:
    external: true

volumes:
  plochy_logs:
    name: plochy_logs

secrets:
  ip_hash_secret:
    external: true

# -----------------------
# Option 2: Compose / non-Swarm fallback (bind-mount secret file)
# -----------------------

# Use this fragment instead of the above `secrets:` usage. Remove the top-level
# `secrets:` block (the one declaring ip_hash_secret) when using this mode.

#services:
#  plochy_harvesine:
#    image: smilecz/plochy_harvesine:latest
#    restart: unless-stopped
#    networks:
#      - edge
#    environment:
#      - ACCESS_LOG_FILE=/logs/access.log
#      - ANONYMIZE_IP=true
#      - ACCESS_LOG_BUFFER_SIZE=1000
#      - LOG_ROTATE_BYTES=10485760
#      - LOG_ROTATE_MAX_FILES=5
#      - LOG_ROTATE_CHECK_INTERVAL=60
#      - LOG_ROTATE_MIN_INTERVAL_SECONDS=10
#    volumes:
#      - plochy_logs:/logs
#      - ./secrets/ip_hash_secret:/run/secrets/ip_hash_secret:ro
#    labels:
#      - "traefik.enable=true"
#      - "traefik.docker.network=edge"
#      - "traefik.http.routers.plochy.rule=Host(`plochy-harvesine.gearground.cloud`)"
#      - "traefik.http.routers.plochy.entrypoints=websecure"
#      - "traefik.http.routers.plochy.tls=true"
#      - "traefik.http.routers.plochy.tls.certresolver=le"
#      - "traefik.http.routers.plochy.priority=100"
#      - "traefik.http.services.plochy.loadbalancer.server.port=80"
#    deploy:
#      resources:
#        limits:
#          memory: 32M
#
#networks:
#  edge:
#    external: true
#
#volumes:
#  plochy_logs:
#    name: plochy_logs

# End of example
